{"version":3,"file":"4.0c320b34533acf045deb.hot-update.js","sources":["webpack:///static/auth.js","webpack:///static/template.js"],"sourcesContent":["import Cookie from 'js-cookie';\r\nimport jwt from 'jsonwebtoken';\r\nimport fetch from 'isomorphic-unfetch';\r\nimport * as settings from '../settings';\r\n\r\nasync function getJWK() {\r\n  const res = await fetch(`https://${settings.domain}/.well-known/jwks.json`);\r\n  const jwk = await res.json();\r\n  return jwk;\r\n}\r\n\r\nfunction saveToken(jwtToken, accessToken) {\r\n  Cookie.set('user', jwt.decode(jwtToken));\r\n  Cookie.set('jwtToken', jwtToken);\r\n};\r\n\r\nfunction deleteToken() {\r\n  Cookie.remove('user');\r\n  Cookie.remove('jwtToken');\r\n};\r\n\r\nasync function verifyToken(token) {\r\n  if (token) {\r\n    const decodedToken = jwt.decode(token, { complete: true });\r\n    const jwk = await getJWK();\r\n    let cert = jwk.keys[0].x5c[0];\r\n    cert = cert.match(/.{1,64}/g).join('\\n');\r\n    cert = `-----BEGIN CERTIFICATE-----\\n${cert}\\n-----END CERTIFICATE-----\\n`;\r\n    if (jwk.keys[0].kid === decodedToken.header.kid) {\r\n      try {\r\n        jwt.verify(token, cert);\r\n        return true;\r\n      } catch (error) {\r\n        console.error(error);\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nasync function getTokenForBrowser() {\r\n  const token = Cookie.getJSON('jwtToken');\r\n  const validToken = await verifyToken(token);\r\n  if (validToken) {\r\n    return Cookie.getJSON('user');\r\n  }\r\n}\r\n\r\nasync function getTokenForServer(req) {\r\n  if (req.headers.cookie) {\r\n    const jwtFromCookie = req.headers.cookie.split(';').find(c => c.trim().startsWith('jwtToken='));\r\n    if (!jwtFromCookie) {\r\n      return undefined;\r\n    }\r\n    const token = jwtFromCookie.split('=')[1];\r\n    const validToken = await verifyToken(token);\r\n    if (validToken) {\r\n      return jwt.decode(token);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n}\r\n\r\nexport {\r\n  saveToken,\r\n  deleteToken,\r\n  getTokenForBrowser,\r\n  getTokenForServer,\r\n  verifyToken\r\n};\n\n\n// WEBPACK FOOTER //\n// static/auth.js","import React from 'react';\r\nimport Navbar from '../components/Navbar';\r\nimport { getTokenForBrowser, getTokenForServer } from '../static/auth';\r\n\r\nexport default Page => class Template extends React.Component {\r\n  static async getInitialProps({ req }) {\r\n    const loggedInUser = process.browser ? await getTokenForBrowser() : await getTokenForServer(req);\r\n    const pageProperties = await Page.getInitialProps && await Page.getInitialProps(req);\r\n    return {\r\n      ...pageProperties,\r\n      loggedInUser,\r\n      isLoggedIn: !!loggedInUser\r\n    }\r\n  }\r\n\r\n  render() {\r\n    return (\r\n      <div>\r\n        <Navbar { ...this.props } />\r\n        <br/>\r\n        <Page { ...this.props } />\r\n      </div>\r\n    )\r\n  }\r\n}\n\n\n// WEBPACK FOOTER //\n// static/template.js"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AACA;AADA;AAAA;AACA;AADA;AAEA;AAFA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;AAMA;AACA;AACA;AACA;AACA;AADA;AACA;AACA;AACA;AACA;AACA;AACA;AADA;AACA;AACA;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAFA;AAAA;AACA;AADA;AAGA;AACA;AACA;AACA;AACA;AAPA;AAAA;AAAA;AAAA;AACA;AADA;AASA;AATA;AACA;AADA;AAAA;AAAA;AAYA;AAZA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;AAmBA;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAEA;AACA;AAHA;AAAA;AAAA;AAAA;AACA;AADA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;AAQA;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAHA;AAAA;AAAA;AAAA;AACA;AADA;AACA;AADA;AAMA;AANA;AAAA;AACA;AADA;AAOA;AACA;AARA;AAAA;AAAA;AAAA;AACA;AADA;AACA;AADA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;AAgBA;;;;;;;;;;;;AA3DA;AAMA;AAKA;AAKA;AAmBA;AAQA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChDA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAAA;AAAA;AAYA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AAnBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAFA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAEA;AAFA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAGA;AAHA;AAMA;AACA;AAPA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AACA;AADA;;;;;;;;;;;;;;;;;;;;;A","sourceRoot":""}